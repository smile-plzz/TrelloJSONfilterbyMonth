<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trello JSON Month/Year Filter</title>
  <style>
    :root { --bg: #0b1220; --panel:#101827; --muted:#6b7280; --text:#e5e7eb; --accent:#60a5fa; --border:#1f2937; --good:#34d399; --bad:#fca5a5; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220 0%,#0e1528 100%);color:var(--text);font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif}
    .wrap{max-width:1100px;margin:40px auto;padding:0 20px}
    .card{background:rgba(255,255,255,0.03);backdrop-filter: blur(6px);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:20px}
    h1{font-size:clamp(22px,2.8vw,32px);margin:0;font-weight:700;letter-spacing:.2px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .panel{padding:18px}
    label{display:block;font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin:8px 0 6px}
    input[type="number"],select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0c1426;color:var(--text)}
    textarea{min-height:112px;resize:vertical}
    input[type="file"]{width:100%;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .radio-group,.check-group{display:flex;gap:10px;flex-wrap:wrap}
    .chip{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0c1426}
    button{appearance:none;border:1px solid transparent;background:linear-gradient(180deg,#2563eb,#1d4ed8);color:white;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer;transition:.15s transform ease, .15s filter ease}
    button:hover{filter:brightness(1.1)}
    button:active{transform:translateY(1px)}
    .btn-secondary{background:transparent;border-color:var(--border);color:var(--text)}
    .btn-ghost{background:transparent;border-color:transparent;color:var(--muted)}
    .kpi{display:flex;gap:16px;flex-wrap:wrap}
    .kpi .item{flex:1 1 200px;background:#0c1426;border:1px solid var(--border);border-radius:12px;padding:12px}
    .kpi .val{font-size:22px;font-weight:700}
    table{width:100%;border-collapse:collapse;border:1px solid var(--border)}
    th,td{border-bottom:1px solid var(--border);padding:10px 12px;text-align:left;font-size:14px}
    th{color:#9aa5b1;font-weight:600;background:#0c1426;position:sticky;top:0}
    tbody tr:hover{background:rgba(255,255,255,0.03)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12.5px}
    .footer{color:var(--muted);font-size:12px;margin-top:14px}
    .alert{background:#0c1426;border:1px solid var(--border);border-radius:12px;padding:10px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#0f1a33;border:1px solid var(--border)}
    .hidden{display:none}
    .sticky-bar{position:sticky;top:0;z-index:5;background:rgba(14,21,40,.75);backdrop-filter: blur(6px);border-bottom:1px solid var(--border)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Trello JSON Month/Year Filter</h1>
      <div class="muted">Upload a Trello board export and extract <strong>cards</strong> or <strong>actions</strong> for a selected month/year. Entirely offline.</div>
    </header>

    <section class="card panel">
      <div class="grid">
        <div class="col" style="grid-column: span 6">
          <label>Upload Trello JSON export</label>
          <input id="file" type="file" accept="application/json,.json" />
        </div>
        <div class="col" style="grid-column: span 6">
          <label>Or paste Trello JSON</label>
          <textarea id="jsonText" placeholder='{"cards":[],"actions":[]...}'></textarea>
        </div>
      </div>

      <div class="grid" style="margin-top:10px">
        <div class="col" style="grid-column: span 3">
          <label>Year</label>
          <input id="year" type="number" min="2009" max="2100" />
        </div>
        <div class="col" style="grid-column: span 3">
          <label>Month</label>
          <select id="month">
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
        </div>
        <div class="col" style="grid-column: span 6">
          <label>Filter Target</label>
          <div class="radio-group" role="radiogroup" aria-label="Filter target">
            <label class="chip"><input type="radio" name="target" value="cards" checked /> Cards</label>
            <label class="chip"><input type="radio" name="target" value="actions" /> Actions</label>
          </div>
        </div>
      </div>

      <div id="cardsOptions" class="grid" style="margin-top:10px">
        <div class="col" style="grid-column: span 6">
          <label>Cards date field</label>
          <select id="cardDateField">
            <option value="created">Created</option>
            <option value="due">Due</option>
            <option value="lastActivity">Last Activity</option>
          </select>
        </div>
        <div class="col" style="grid-column: span 6">
          <label>Include closed cards</label>
          <div class="check-group">
            <label class="chip"><input id="includeClosed" type="checkbox" checked /> Include closed</label>
          </div>
        </div>
      </div>

      <div id="actionsOptions" class="grid hidden" style="margin-top:10px">
        <div class="col" style="grid-column: span 12">
          <label>Action types (optional)</label>
          <div class="row" id="actionTypes"></div>
          <div class="footer">If none selected, all action types are included.</div>
        </div>
      </div>

      <div class="row" style="margin-top:16px;justify-content:space-between">
        <div class="row">
          <button id="btnFilter">Filter</button>
          <button id="btnDownload" class="btn-secondary" disabled>Download JSON</button>
          <button id="btnCopy" class="btn-ghost" disabled>Copy JSON</button>
        </div>
        <div class="row">
          <span class="pill"><span id="status">No file loaded</span></span>
        </div>
      </div>
    </section>

    <section class="panel card" style="margin-top:14px">
      <div class="kpi">
        <div class="item">
          <div class="muted">Original</div>
          <div class="val"><span id="kCards">0</span> cards • <span id="kActions">0</span> actions</div>
        </div>
        <div class="item">
          <div class="muted">Filtered result</div>
          <div class="val"><span id="kFiltered">0</span> items</div>
        </div>
      </div>

      <div class="sticky-bar panel" style="margin-top:8px">
        <div class="row">
          <div class="muted">Preview (first 200 items)</div>
        </div>
      </div>

      <div id="preview" class="panel" style="padding-top:0">
        <div class="alert muted">Load a JSON file and click <strong>Filter</strong> to see results.</div>
      </div>
    </section>

    <!-- Monthly report (for actions) -->
    <section id="reportSection" class="panel card hidden" style="margin-top:14px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="muted">Monthly Report (built from <strong>Actions</strong> — includes comments when no type is selected)</div>
        <div class="row">
          <button id="btnActionsCsv" class="btn-secondary" disabled>Download Actions CSV</button>
          <button id="btnTypesCsv" class="btn-secondary" disabled>Download By‑Type CSV</button>
          <button id="btnMembersCsv" class="btn-secondary" disabled>Download By‑Member CSV</button>
          <button id="btnDaysCsv" class="btn-secondary" disabled>Download By‑Day CSV</button>
        </div>
      </div>
      <div id="reportBox" class="panel" style="margin-top:10px">
        <div class="alert muted">Filter Actions to build a monthly report (includes comments).</div>
      </div>
    </section>

    <div class="footer">Works with Trello board JSON exported via the board menu → <em>More</em> → <em>Print and export</em> → <em>Export as JSON</em>. All processing is done locally in your browser.</div>
  </div>

<script>
(function(){
  // ---------- Utilities ----------
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  const byId = (id) => document.getElementById(id);

  function monthRange(year, month){
    const start = new Date(Date.UTC(year, month-1, 1));
    const end = new Date(Date.UTC(month===12?year+1:year, month===12?0:month, 1));
    return {start, end};
  }
  function parseISO(s){ if(!s) return null; const d = new Date(s); return isNaN(d) ? null : d; }
  function createdFromId(id){
    try{ const secs = parseInt(id.slice(0,8),16); return new Date(secs*1000); }catch{ return null }
  }
  function dl(filename, text){
    const blob = new Blob([text], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
  }
  function dlCsv(filename, rows, headers){
    const encode = (v)=>{
      if(v===null||v===undefined) return '';
      const s = String(v);
      return /[",
]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s;
    };
    const cols = headers || Object.keys(rows[0]||{});
    const lines = [cols.join(',')].concat(rows.map(r=>cols.map(c=>encode(r[c])).join(',')));
    const blob = new Blob([lines.join('
')], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
  }

  // ---------- State ----------
  let board = null; // parsed Trello export
  let lastResult = null; // filtered array

  // ---------- DOM refs ----------
  const fileInput = byId('file');
  const jsonText = byId('jsonText');
  const year = byId('year');
  const month = byId('month');
  const status = byId('status');
  const btnFilter = byId('btnFilter');
  const btnDownload = byId('btnDownload');
  const btnCopy = byId('btnCopy');
  const kCards = byId('kCards');
  const kActions = byId('kActions');
  const kFiltered = byId('kFiltered');
  const preview = byId('preview');
  const cardsOptions = byId('cardsOptions');
  const actionsOptions = byId('actionsOptions');
  const cardDateField = byId('cardDateField');
  const includeClosed = byId('includeClosed');
  const actionTypesWrap = byId('actionTypes');
  const reportBox = byId('reportBox');
  const btnActionsCsv = byId('btnActionsCsv');
  const btnTypesCsv = byId('btnTypesCsv');
  const btnMembersCsv = byId('btnMembersCsv');
  const btnDaysCsv = byId('btnDaysCsv');

  // ---------- Setup defaults ----------
  const now = new Date();
  year.value = now.getUTCFullYear();
  month.value = now.getUTCMonth()+1;

  // Popular action types (user can still filter others via JSON edit if needed)
  const POP_TYPES = [
    'createCard','commentCard','updateCard','copyCard','deleteCard','moveCardToBoard','moveCardFromBoard',
    'convertToCardFromCheckItem','addChecklistToCard','removeChecklistFromCard','addAttachmentToCard','addMemberToCard'
  ];
  POP_TYPES.forEach(t=>{
    const id = `t_${t}`;
    const label = document.createElement('label');
    label.className = 'chip';
    label.innerHTML = `<input type="checkbox" value="${t}" id="${id}"> ${t}`;
    actionTypesWrap.appendChild(label);
  });

  // ---------- Target toggle ----------
  $$("input[name='target']").forEach(r=>{
    r.addEventListener('change',()=>{
      const val = document.querySelector("input[name='target']:checked").value;
      cardsOptions.classList.toggle('hidden', val!=="cards");
      actionsOptions.classList.toggle('hidden', val!=="actions");
      // Report area is only for actions
      document.getElementById('reportSection').classList.toggle('hidden', val!=="actions");
    })
  })

  // ---------- Load handlers ----------
  fileInput.addEventListener('change', async (e)=>{
    const f = e.target.files?.[0];
    if(!f){ return; }
    try{
      const text = await f.text();
      const data = JSON.parse(text);
      board = data; jsonText.value = '';
      updateStats();
      status.textContent = `Loaded file: ${f.name}`;
      preview.innerHTML = `<div class='alert'>File loaded. Choose filters then click <strong>Filter</strong>.</div>`;
      clearReport();
    }catch(err){
      status.textContent = 'Failed to parse JSON file';
    }
  });

  jsonText.addEventListener('blur', ()=>{
    if(!jsonText.value.trim()) return;
    try{
      const data = JSON.parse(jsonText.value);
      board = data; fileInput.value = '';
      updateStats();
      status.textContent = 'JSON pasted';
      preview.innerHTML = `<div class='alert'>JSON parsed. Choose filters then click <strong>Filter</strong>.</div>`;
      clearReport();
    }catch(err){ status.textContent = 'Invalid JSON (paste)'; }
  });

  function updateStats(){
    if(!board){ kCards.textContent = '0'; kActions.textContent='0'; return; }
    const cards = Array.isArray(board.cards)? board.cards.length : 0;
    const actions = Array.isArray(board.actions)? board.actions.length : 0;
    kCards.textContent = String(cards);
    kActions.textContent = String(actions);
  }

  // ---------- Filtering core ----------
  function indexFirstCreateActions(actions){
    const map = new Map(); // cardId -> Date
    for(const a of actions||[]){
      if(a?.type === 'createCard'){
        const cardId = a?.data?.card?.id; const dt = parseISO(a?.date);
        if(cardId && dt){ if(!map.has(cardId) || dt < map.get(cardId)) map.set(cardId, dt); }
      }
    }
    return map;
  }

  function filterCardsByMonth(board, year, month, dateField, includeClosed){
    const {start,end} = monthRange(year, month);
    const cards = board.cards || [];
    const createIdx = indexFirstCreateActions(board.actions);
    const out = [];
    for(const c of cards){
      if(!includeClosed && c.closed) continue;
      let dt = null;
      if(dateField === 'created'){ dt = createIdx.get(c.id) || createdFromId(c.id); }
      else if(dateField === 'due'){ dt = parseISO(c.due); }
      else if(dateField === 'lastActivity'){ dt = parseISO(c.dateLastActivity); }
      if(!dt) continue;
      if(dt >= start && dt < end){
        out.push({
          id: c.id,
          name: c.name,
          listId: c.idList,
          due: c.due,
          dateLastActivity: c.dateLastActivity,
          createdAt: (createIdx.get(c.id) || createdFromId(c.id))?.toISOString() ?? null
        });
      }
    }
    return out;
  }

  function filterActionsByMonth(board, year, month, types){
    const {start,end} = monthRange(year, month);
    const set = types && types.length ? new Set(types) : null;
    const out = [];
    for(const a of board.actions || []){
      const dt = parseISO(a.date);
      if(!dt || dt < start || dt >= end) continue;
      if(set && !set.has(a.type)) continue;
      out.push({
        date: new Date(a.date).toISOString(),
        type: a.type,
        memberCreator: a?.memberCreator?.fullName,
        memberId: a?.memberCreator?.id,
        card: a?.data?.card?.name,
        cardId: a?.data?.card?.id,
        list: a?.data?.list?.name || a?.data?.listAfter?.name,
        data: a.data
      });
    }
    return out;
  }

  // ---------- Report ----------
  function buildReport(actions){
    const summary = {
      total: actions.length,
      comments: 0,
      creates: 0,
      deletes: 0,
      movesToBoard: 0,
      movesFromBoard: 0,
      updates: 0,
      attachments: 0,
      checklists: 0,
      uniqueMembers: new Set(),
      perType: new Map(),
      perMember: new Map(),
      perDay: new Map()
    };

    for(const a of actions){
      summary.uniqueMembers.add(a.memberId || a.memberCreator || 'Unknown');
      inc(summary.perType, a.type);
      inc(summary.perMember, a.memberCreator || 'Unknown');
      const day = (a.date||'').slice(0,10); // YYYY-MM-DD
      inc(summary.perDay, day);
      if(a.type==='commentCard') summary.comments++;
      if(a.type==='createCard') summary.creates++;
      if(a.type==='deleteCard') summary.deletes++;
      if(a.type==='moveCardToBoard') summary.movesToBoard++;
      if(a.type==='moveCardFromBoard') summary.movesFromBoard++;
      if(a.type==='updateCard') summary.updates++;
      if(a.type==='addAttachmentToCard') summary.attachments++;
      if(a.type==='addChecklistToCard' || a.type==='removeChecklistFromCard') summary.checklists++;
    }
    return summary;

    function inc(map, key){ map.set(key, (map.get(key)||0)+1); }
  }

  function renderReport(summary){
    if(!summary){ reportBox.innerHTML = `<div class='alert muted'>No actions filtered yet.</div>`; return; }

    const kv = (k,v)=>`<div class='item'><div class='muted'>${k}</div><div class='val'>${v}</div></div>`;
    const head = `
      <div class='kpi'>
        ${kv('Total actions', summary.total)}
        ${kv('Comments', summary.comments)}
        ${kv('Cards created', summary.creates)}
        ${kv('Moves ↦ Board', summary.movesToBoard)}
        ${kv('Moves ↤ Board', summary.movesFromBoard)}
        ${kv('Updates', summary.updates)}
        ${kv('Attachments', summary.attachments)}
        ${kv('Checklist ops', summary.checklists)}
        ${kv('Participants', summary.uniqueMembers.size)}
      </div>`;

    const mapToRows = (m, key='key', val='count') => Array.from(m.entries()).sort((a,b)=>b[1]-a[1]).map(([k,v])=>({[key]:k,[val]:v}));

    const perTypeRows = mapToRows(summary.perType, 'type');
    const perMemberRows = mapToRows(summary.perMember, 'member');
    const perDayRows = mapToRows(summary.perDay, 'day');

    const table = (title, rows, cols) => {
      if(!rows.length) return '';
      return `
        <div class='panel' style='margin-top:10px'>
          <div class='muted'>${title}</div>
          <div style='overflow:auto;max-height:280px'>
            <table class='mono'>
              <thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead>
              <tbody>
                ${rows.map(r=>`<tr>${cols.map(c=>`<td>${escapeHtml(String(r[c] ?? ''))}</td>`).join('')}</tr>`).join('')}
              </tbody>
            </table>
          </div>
        </div>`;
    };

    const html = [head,
      table('Actions by type', perTypeRows, ['type','count']),
      table('Actions by member', perMemberRows, ['member','count']),
      table('Actions by day', perDayRows, ['day','count'])
    ].join('');

    reportBox.innerHTML = html;

    // enable CSV buttons
    btnActionsCsv.disabled = !lastResult || !lastResult.length;
    btnTypesCsv.disabled = perTypeRows.length===0;
    btnMembersCsv.disabled = perMemberRows.length===0;
    btnDaysCsv.disabled = perDayRows.length===0;

    // attach datasets for download handlers
    reportBox.dataset.perType = JSON.stringify(perTypeRows);
    reportBox.dataset.perMember = JSON.stringify(perMemberRows);
    reportBox.dataset.perDay = JSON.stringify(perDayRows);
  }

  function clearReport(){
    reportBox.innerHTML = `<div class='alert muted'>Filter Actions to build a monthly report (includes comments).</div>`;
    btnActionsCsv.disabled = btnTypesCsv.disabled = btnMembersCsv.disabled = btnDaysCsv.disabled = true;
  }

  // ---------- Render preview ----------
  function renderPreview(items){
    if(!items || !items.length){ preview.innerHTML = `<div class='alert'>No results for the selected month/year.</div>`; return; }
    const isCard = 'name' in items[0] && 'listId' in items[0];

    const cols = isCard
      ? ['id','name','listId','due','dateLastActivity','createdAt']
      : ['date','type','memberCreator','card','list'];

    const limit = items.slice(0,200);
    let html = `<div style='overflow:auto;max-height:420px'><table class='mono'><thead><tr>` +
      cols.map(c=>`<th>${c}</th>`).join('') + `</tr></thead><tbody>` +
      limit.map(row=>`<tr>`+cols.map(c=>`<td>${escapeHtml(String(row[c] ?? ''))}</td>`).join('')+`</tr>`).join('')+
      `</tbody></table></div>`;

    if(items.length > limit.length){
      html += `<div class='footer'>Showing first ${limit.length} of ${items.length} rows.</div>`;
    }
    preview.innerHTML = html;
  }

  function escapeHtml(s){
    return s
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }

  // ---------- Actions ----------
  btnFilter.addEventListener('click', ()=>{
    if(!board){ status.textContent = 'Please load JSON first'; return; }
    const y = parseInt(year.value,10); const m = parseInt(month.value,10);
    if(!(y>=2009 && y<=2100) || !(m>=1 && m<=12)){ status.textContent = 'Enter a valid month/year'; return; }

    const target = document.querySelector("input[name='target']:checked").value;

    if(target === 'cards'){
      lastResult = filterCardsByMonth(board, y, m, cardDateField.value, includeClosed.checked);
      // hide report when looking at cards
      document.getElementById('reportSection').classList.add('hidden');
    } else {
      const selected = $$('#actionTypes input:checked').map(i=>i.value);
      // NOTE: If nothing selected, includes ALL actions (including comments)
      lastResult = filterActionsByMonth(board, y, m, selected.length? selected : null);
      document.getElementById('reportSection').classList.remove('hidden');
      const summary = buildReport(lastResult);
      renderReport(summary);
    }

    kFiltered.textContent = String(lastResult.length);
    renderPreview(lastResult);
    btnDownload.disabled = btnCopy.disabled = lastResult.length === 0;

    const label = target === 'cards' ? `${cardDateField.value}` : 'actions';
    status.textContent = `Filtered ${lastResult.length} ${label} for ${y}-${String(m).padStart(2,'0')}`;
  });

  btnDownload.addEventListener('click', ()=>{
    if(!lastResult) return;
    const y = year.value, m = String(month.value).padStart(2,'0');
    const target = document.querySelector("input[name='target']:checked").value;
    const payload = JSON.stringify(lastResult, null, 2);
    dl(`trello_${target}_${y}-${m}.json`, payload);
  });

  byId('btnActionsCsv').addEventListener('click', ()=>{
    if(!lastResult?.length) return;
    dlCsv('actions.csv', lastResult.map(a=>({
      date:a.date, type:a.type, member:a.memberCreator, card:a.card, list:a.list
    })), ['date','type','member','card','list']);
  });
  byId('btnTypesCsv').addEventListener('click', ()=>{
    const rows = JSON.parse(reportBox.dataset.perType || '[]');
    if(!rows.length) return; dlCsv('actions_by_type.csv', rows, ['type','count']);
  });
  byId('btnMembersCsv').addEventListener('click', ()=>{
    const rows = JSON.parse(reportBox.dataset.perMember || '[]');
    if(!rows.length) return; dlCsv('actions_by_member.csv', rows, ['member','count']);
  });
  byId('btnDaysCsv').addEventListener('click', ()=>{
    const rows = JSON.parse(reportBox.dataset.perDay || '[]');
    if(!rows.length) return; dlCsv('actions_by_day.csv', rows, ['day','count']);
  });

  btnCopy.addEventListener('click', async ()=>{
    if(!lastResult) return;
    try{ await navigator.clipboard.writeText(JSON.stringify(lastResult, null, 2)); status.textContent = 'Copied result JSON to clipboard'; }
    catch{ status.textContent = 'Copy failed (clipboard blocked)'; }
  });

})();
</script>
</body>
</html>
